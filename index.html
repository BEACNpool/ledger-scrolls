<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ledger Scrolls â€” A Library That Cannot Burn</title>
  <meta name="description" content="Immutable documents stored forever on the Cardano blockchain. No indexing. No gatekeepers. No censorship.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    /* â”€â”€â”€ TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --bg:         #070a10;
      --bg2:        #0d1118;
      --surface:    #111827;
      --surface2:   #1a2235;
      --surface3:   #222c3f;
      --gold:       #c9a84c;
      --gold-glow:  rgba(201,168,76,0.18);
      --gold-dim:   rgba(201,168,76,0.1);
      --ada:        #0ea5c5;
      --ada-dim:    rgba(14,165,197,0.12);
      --text:       #d8d0c0;
      --text-dim:   #8a8070;
      --text-muted: #4a4540;
      --border:     rgba(201,168,76,0.18);
      --border-ada: rgba(14,165,197,0.22);
      --success:    #4caf7d;
      --warn:       #e09050;
      --error:      #e05252;
      --radius:     8px;
      --transition: 200ms cubic-bezier(0.4,0,0.2,1);
      --font-display: 'Cinzel', serif;
      --font-body:    'Crimson Pro', Georgia, serif;
      --font-mono:    'JetBrains Mono', 'Courier New', monospace;
    }
    [data-theme="light"] {
      --bg:         #f5f0e8;
      --bg2:        #ede7d9;
      --surface:    #ffffff;
      --surface2:   #f7f2ea;
      --surface3:   #ede6d8;
      --text:       #1a1612;
      --text-dim:   #4a4038;
      --text-muted: #9a9088;
      --border:     rgba(140,100,20,0.2);
      --border-ada: rgba(14,165,197,0.3);
      --gold:       #a07820;
      --gold-glow:  rgba(160,120,32,0.15);
      --gold-dim:   rgba(160,120,32,0.1);
      --surface3:   #e8e0ce;
    }
    [data-theme="parchment"] {
      --bg:         #2a1f0e;
      --bg2:        #221806;
      --surface:    #3a2c15;
      --surface2:   #453520;
      --surface3:   #52412b;
      --text:       #e8d8a0;
      --text-dim:   #a09060;
      --text-muted: #705840;
      --border:     rgba(232,200,100,0.25);
      --gold:       #e8c860;
      --gold-glow:  rgba(232,200,96,0.2);
    }

    /* â”€â”€â”€ BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    html, body { height: 100%; }
    body {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--text);
      font-size: 16px;
      line-height: 1.6;
      overflow: hidden;
    }
    ::selection { background: var(--gold-glow); color: var(--gold); }

    /* â”€â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 99px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--gold-dim); }

    /* â”€â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-image: radial-gradient(ellipse at 20% 20%, rgba(201,168,76,0.04) 0%, transparent 60%),
                        radial-gradient(ellipse at 80% 80%, rgba(14,165,197,0.04) 0%, transparent 60%);
    }

    /* â”€â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .topbar {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 0 24px;
      height: 60px;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      position: relative;
      z-index: 100;
    }
    .topbar::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0; right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--gold), transparent);
      opacity: 0.4;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      flex-shrink: 0;
    }
    .logo-icon {
      font-size: 22px;
      filter: drop-shadow(0 0 8px var(--gold));
      animation: float 4s ease-in-out infinite;
    }
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
    .logo-text {
      font-family: var(--font-display);
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.12em;
      color: var(--gold);
      text-shadow: 0 0 20px rgba(201,168,76,0.4);
    }
    .logo-sub {
      font-family: var(--font-body);
      font-size: 11px;
      color: var(--text-dim);
      letter-spacing: 0.05em;
      font-style: italic;
    }
    .logo-block { display: flex; flex-direction: column; }

    .topbar-spacer { flex: 1; }

    .conn-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 99px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
      transition: var(--transition);
    }
    .conn-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: var(--transition);
    }
    .conn-badge.online .conn-dot { background: var(--success); box-shadow: 0 0 6px var(--success); }
    .conn-badge.online { color: var(--success); border-color: rgba(76,175,125,0.3); }
    .conn-badge.connecting .conn-dot {
      background: var(--warn);
      animation: pulse 1s infinite;
    }
    .conn-badge.error .conn-dot { background: var(--error); }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.3; } }
    #conn-text { letter-spacing: 0.06em; }

    .topbar-btn {
      display: flex; align-items: center; justify-content: center;
      width: 36px; height: 36px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-dim);
      cursor: pointer;
      transition: var(--transition);
      font-size: 16px;
      text-decoration: none;
    }
    .topbar-btn:hover { color: var(--gold); border-color: var(--gold); background: var(--gold-dim); }

    /* â”€â”€â”€ BODY LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .body-layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar {
      width: 300px;
      flex-shrink: 0;
      background: var(--bg2);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .sidebar-header {
      padding: 16px 20px 14px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .sidebar-title {
      font-family: var(--font-display);
      font-size: 11px;
      letter-spacing: 0.16em;
      color: var(--text-dim);
      text-transform: uppercase;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .scroll-counter {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
    }
    .sidebar-nav {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 12px;
    }
    .nav-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 7px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-dim);
      cursor: pointer;
      transition: var(--transition);
      font-family: var(--font-mono);
      font-size: 11px;
      letter-spacing: 0.06em;
    }
    .nav-btn:hover { color: var(--gold); border-color: var(--gold); background: var(--gold-dim); }
    .nav-btn:disabled { opacity: 0.35; cursor: not-allowed; }

    .scroll-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .scroll-item {
      padding: 12px 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    .scroll-item::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 3px;
      background: transparent;
      transition: var(--transition);
    }
    .scroll-item:hover { background: var(--surface2); border-color: rgba(201,168,76,0.35); }
    .scroll-item:hover::before { background: var(--gold); }
    .scroll-item.active { background: var(--gold-dim); border-color: rgba(201,168,76,0.5); }
    .scroll-item.active::before { background: var(--gold); }
    .scroll-item-title {
      font-family: var(--font-body);
      font-size: 13.5px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 5px;
      line-height: 1.3;
    }
    .scroll-item-meta {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .badge {
      font-family: var(--font-mono);
      font-size: 9px;
      letter-spacing: 0.08em;
      padding: 2px 6px;
      border-radius: 3px;
      text-transform: uppercase;
    }
    .badge-standard { background: var(--ada-dim); color: var(--ada); border: 1px solid var(--border-ada); }
    .badge-legacy { background: rgba(201,168,76,0.12); color: var(--gold); border: 1px solid rgba(201,168,76,0.3); }
    .badge-type {
      font-family: var(--font-mono);
      font-size: 9px;
      color: var(--text-muted);
      letter-spacing: 0.05em;
    }

    .sidebar-footer {
      padding: 12px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .sidebar-action {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-dim);
      cursor: pointer;
      transition: var(--transition);
      font-family: var(--font-body);
      font-size: 13px;
      width: 100%;
      text-align: left;
    }
    .sidebar-action:hover { color: var(--gold); border-color: var(--gold); background: var(--gold-dim); }
    .sidebar-action span.icon { font-size: 15px; }

    /* â”€â”€â”€ MAIN VIEWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .viewer {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg);
    }

    /* Welcome / hero state */
    .welcome {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
      padding: 48px 32px;
      text-align: center;
    }
    .welcome-glyph {
      font-size: 64px;
      filter: drop-shadow(0 0 32px rgba(201,168,76,0.5));
      animation: float 5s ease-in-out infinite;
    }
    .welcome-title {
      font-family: var(--font-display);
      font-size: 28px;
      font-weight: 600;
      color: var(--gold);
      letter-spacing: 0.08em;
      text-shadow: 0 0 40px rgba(201,168,76,0.3);
    }
    .welcome-sub {
      font-family: var(--font-body);
      font-size: 16px;
      font-style: italic;
      color: var(--text-dim);
      max-width: 480px;
    }
    .welcome-pillars {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      max-width: 460px;
      width: 100%;
      margin-top: 8px;
    }
    .pillar {
      padding: 12px 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: var(--font-body);
      font-size: 13px;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .welcome-featured {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 520px;
    }
    .feat-link {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 8px 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 99px;
      color: var(--text-dim);
      text-decoration: none;
      font-family: var(--font-body);
      font-size: 13px;
      transition: var(--transition);
    }
    .feat-link:hover { color: var(--gold); border-color: var(--gold); background: var(--gold-dim); }
    .feat-link .icon { font-size: 14px; }
    .beacn-credit {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.06em;
    }
    .beacn-credit a { color: var(--text-muted); transition: var(--transition); }
    .beacn-credit a:hover { color: var(--gold); }

    /* Viewer header (when scroll loaded) */
    .viewer-header {
      display: none;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .viewer-header.visible { display: flex; }
    .viewer-scroll-title {
      font-family: var(--font-display);
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      letter-spacing: 0.04em;
    }
    .viewer-spacer { flex: 1; }
    .viewer-action {
      display: flex; align-items: center; gap: 6px;
      padding: 5px 10px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-dim);
      cursor: pointer;
      transition: var(--transition);
      font-family: var(--font-mono);
      font-size: 11px;
    }
    .viewer-action:hover { color: var(--gold); border-color: var(--gold); }

    /* Content frame */
    .content-area {
      flex: 1;
      overflow: auto;
      position: relative;
    }
    #content-frame {
      width: 100%; height: 100%;
      border: none;
      display: none;
      background: white;
    }
    #content-image {
      display: none;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      padding: 24px;
    }
    #content-text {
      display: none;
      padding: 32px;
      font-family: var(--font-mono);
      font-size: 12.5px;
      line-height: 1.7;
      color: var(--text);
      white-space: pre-wrap;
      word-break: break-all;
    }
    #content-video {
      display: none;
      width: 100%;
      max-height: 100%;
      object-fit: contain;
      background: black;
    }

    /* Loading state */
    .loading-overlay {
      display: none;
      position: absolute;
      inset: 0;
      background: rgba(7,10,16,0.85);
      backdrop-filter: blur(4px);
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      z-index: 10;
    }
    .loading-overlay.visible { display: flex; }
    .spinner {
      width: 40px; height: 40px;
      border: 2px solid var(--surface3);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-dim);
      letter-spacing: 0.08em;
      max-width: 320px;
      text-align: center;
    }
    .loading-step {
      font-size: 11px;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    /* Details panel */
    .details-panel {
      display: none;
      padding: 14px 20px;
      background: var(--bg2);
      border-top: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
      line-height: 1.8;
      flex-shrink: 0;
      max-height: 160px;
      overflow-y: auto;
    }
    .details-panel.visible { display: block; }
    .detail-row { display: flex; gap: 12px; }
    .detail-key { color: var(--text-muted); min-width: 120px; flex-shrink: 0; }
    .detail-val { color: var(--text-dim); word-break: break-all; }
    .detail-val.hash { color: var(--ada); }
    .detail-val.match { color: var(--success); }
    .detail-val.mismatch { color: var(--error); }

    /* â”€â”€â”€ PANELS (Settings / About / Verify / Custom) â”€â”€â”€â”€â”€â”€â”€ */
    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      z-index: 200;
      align-items: flex-start;
      justify-content: flex-end;
      padding: 60px 0 0 0;
    }
    .overlay.center {
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .overlay.visible { display: flex; }

    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-right: none;
      width: 420px;
      height: calc(100vh - 60px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      box-shadow: -20px 0 60px rgba(0,0,0,0.5);
      animation: slideIn 0.25s ease;
    }
    .overlay.center .panel {
      border: 1px solid var(--border);
      border-radius: 12px;
      height: auto;
      max-height: 90vh;
      box-shadow: 0 20px 80px rgba(0,0,0,0.6);
    }
    @keyframes slideIn { from { transform: translateX(30px); opacity:0; } to { transform: none; opacity:1; } }

    .panel-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 20px 24px 18px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .panel-icon { font-size: 20px; }
    .panel-title {
      font-family: var(--font-display);
      font-size: 14px;
      font-weight: 600;
      color: var(--gold);
      letter-spacing: 0.08em;
    }
    .panel-close {
      margin-left: auto;
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 20px;
      width: 32px; height: 32px;
      display: flex; align-items: center; justify-content: center;
      border-radius: var(--radius);
      transition: var(--transition);
    }
    .panel-close:hover { background: var(--surface2); color: var(--text); }

    .panel-body { padding: 20px 24px; flex: 1; overflow-y: auto; }
    .panel-section { margin-bottom: 24px; }
    .panel-section-title {
      font-family: var(--font-display);
      font-size: 11px;
      letter-spacing: 0.14em;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .panel-section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .form-group { margin-bottom: 14px; }
    .form-label {
      display: block;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
      letter-spacing: 0.06em;
      margin-bottom: 6px;
    }
    .form-input {
      width: 100%;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 12px;
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 12px;
      transition: var(--transition);
      outline: none;
    }
    .form-input:focus { border-color: var(--gold); box-shadow: 0 0 0 3px var(--gold-dim); }
    textarea.form-input { resize: vertical; min-height: 80px; line-height: 1.5; }
    .form-hint {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 5px;
      line-height: 1.4;
    }
    select.form-input {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%238a8070'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 30px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 9px 18px;
      border-radius: var(--radius);
      font-family: var(--font-mono);
      font-size: 12px;
      letter-spacing: 0.06em;
      cursor: pointer;
      transition: var(--transition);
      border: none;
    }
    .btn-primary {
      background: var(--gold);
      color: #0a0a08;
      font-weight: 500;
    }
    .btn-primary:hover { background: #dbb85c; box-shadow: 0 0 20px rgba(201,168,76,0.3); }
    .btn-secondary {
      background: var(--surface2);
      color: var(--text-dim);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { color: var(--text); border-color: rgba(201,168,76,0.4); }
    .btn-full { width: 100%; justify-content: center; }

    /* Theme switcher */
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(3,1fr);
      gap: 8px;
    }
    .theme-opt {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 10px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-dim);
      letter-spacing: 0.05em;
    }
    .theme-opt:hover { border-color: var(--gold); }
    .theme-opt.active { border-color: var(--gold); background: var(--gold-dim); color: var(--gold); }
    .theme-swatch {
      width: 100%;
      height: 28px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .swatch-dark { background: #111827; }
    .swatch-light { background: #f5f0e8; }
    .swatch-parchment { background: #3a2c15; }

    /* Tab switcher (for custom scroll) */
    .tabs {
      display: flex;
      gap: 0;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 3px;
      margin-bottom: 20px;
    }
    .tab-btn {
      flex: 1;
      padding: 7px 14px;
      background: none;
      border: none;
      border-radius: 5px;
      color: var(--text-dim);
      cursor: pointer;
      transition: var(--transition);
      font-family: var(--font-mono);
      font-size: 12px;
      letter-spacing: 0.05em;
    }
    .tab-btn.active { background: var(--surface); color: var(--gold); }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }

    /* About panel specifics */
    .about-hero {
      text-align: center;
      padding: 24px 0 20px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }
    .about-glyph {
      font-size: 48px;
      filter: drop-shadow(0 0 20px rgba(201,168,76,0.5));
      display: block;
      margin-bottom: 12px;
    }
    .about-title {
      font-family: var(--font-display);
      font-size: 20px;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 0.1em;
    }
    .about-tagline {
      font-style: italic;
      color: var(--text-dim);
      font-size: 14px;
      margin-top: 6px;
    }
    .principle-list { display: flex; flex-direction: column; gap: 7px; }
    .principle {
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: var(--font-body);
      font-size: 14px;
      color: var(--text-dim);
    }
    .principle-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--gold);
      flex-shrink: 0;
    }
    .about-links { display: flex; flex-direction: column; gap: 8px; }
    .about-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      text-decoration: none;
      color: var(--text-dim);
      transition: var(--transition);
      font-family: var(--font-body);
      font-size: 14px;
    }
    .about-link:hover { border-color: var(--gold); color: var(--text); background: var(--gold-dim); }
    .about-link .icon { font-size: 18px; flex-shrink: 0; }
    .about-link-title { font-weight: 600; color: var(--text); font-size: 13px; display: block; }
    .about-link-sub { font-size: 12px; font-style: italic; color: var(--text-muted); }
    .about-footer {
      text-align: center;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
    }
    .about-footer a { color: var(--text-dim); text-decoration: none; transition: var(--transition); }
    .about-footer a:hover { color: var(--gold); }

    /* Verify panel */
    .verify-result {
      margin-top: 14px;
      padding: 12px 16px;
      border-radius: var(--radius);
      font-family: var(--font-mono);
      font-size: 11px;
      line-height: 1.8;
      display: none;
    }
    .verify-result.pass { background: rgba(76,175,125,0.1); border: 1px solid rgba(76,175,125,0.3); color: var(--success); display: block; }
    .verify-result.fail { background: rgba(224,82,82,0.1); border: 1px solid rgba(224,82,82,0.3); color: var(--error); display: block; }
    .verify-hash { word-break: break-all; font-size: 10px; color: var(--text-muted); margin-top: 4px; }

    /* Status message */
    .status-bar {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 8px 20px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
      flex-shrink: 0;
    }
    .status-bar.visible { display: flex; }
    .status-icon { font-size: 13px; }

    /* Toast notifications */
    #toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 999;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast {
      padding: 10px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text);
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      animation: toastIn 0.3s ease;
      max-width: 320px;
    }
    .toast.success { border-color: rgba(76,175,125,0.4); color: var(--success); }
    .toast.error { border-color: rgba(224,82,82,0.4); color: var(--error); }
    @keyframes toastIn { from { transform: translateX(20px); opacity:0; } to { transform: none; opacity:1; } }

    /* â”€â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 768px) {
      .sidebar { width: 100%; position: absolute; left: -100%; transition: left 0.3s ease; z-index: 50; }
      .sidebar.open { left: 0; }
      .panel { width: 100%; border-right: none; }
    }
  </style>
</head>
<body>
<div id="app">

  <!-- â”€â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header class="topbar">
    <a href="#" class="logo" onclick="return false;">
      <span class="logo-icon">ğŸ“œ</span>
      <div class="logo-block">
        <span class="logo-text">LEDGER SCROLLS</span>
        <span class="logo-sub">A Library That Cannot Burn</span>
      </div>
    </a>
    <div class="topbar-spacer"></div>
    <div class="conn-badge" id="conn-badge">
      <div class="conn-dot" id="conn-dot"></div>
      <span id="conn-text">Offline</span>
    </div>
    <button class="topbar-btn" title="Settings" onclick="openPanel('settings')">âš™ï¸</button>
    <button class="topbar-btn" title="About Ledger Scrolls" onclick="openPanel('about')">â„¹ï¸</button>
    <a class="topbar-btn" href="preview.html" title="Preview Testnet (Experimental)">ğŸ§ª</a>
  </header>

  <!-- â”€â”€â”€ MAIN LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="body-layout">

    <!-- â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">
          <span>ğŸ“š The Library</span>
          <span class="scroll-counter"><span id="scroll-idx">0</span>/<span id="scroll-total">0</span></span>
        </div>
        <div class="sidebar-nav">
          <button class="nav-btn" id="btn-prev" onclick="navigate(-1)" disabled>â† Prev</button>
          <button class="nav-btn" id="btn-next" onclick="navigate(1)" disabled>Next â†’</button>
        </div>
      </div>

      <div class="scroll-list" id="scroll-list">
        <div style="padding:32px 16px; text-align:center; color:var(--text-muted); font-family:var(--font-mono); font-size:11px; letter-spacing:0.06em;">
          <div style="font-size:28px;margin-bottom:12px;">â³</div>
          Loading registryâ€¦
        </div>
      </div>

      <div class="sidebar-footer">
        <button class="sidebar-action" onclick="openPanel('custom')">
          <span class="icon">ğŸ”§</span> Load Custom Scroll
        </button>
        <button class="sidebar-action" onclick="openPanel('verify')">
          <span class="icon">ğŸ”</span> Verify Content
        </button>
      </div>
    </aside>

    <!-- â”€â”€â”€ VIEWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <main class="viewer" id="viewer">

      <!-- Viewer header (shown when scroll loaded) -->
      <div class="viewer-header" id="viewer-header">
        <span id="viewer-scroll-icon">ğŸ“„</span>
        <span class="viewer-scroll-title" id="viewer-title">â€”</span>
        <div class="viewer-spacer"></div>
        <button class="viewer-action" onclick="toggleDetails()" id="btn-details">Details â–¾</button>
        <button class="viewer-action" onclick="openPanel('verify')">ğŸ” Verify</button>
      </div>

      <!-- Content area -->
      <div class="content-area" id="content-area">

        <!-- Welcome / idle state -->
        <div class="welcome" id="welcome">
          <div class="welcome-glyph">ğŸ“œ</div>
          <div class="welcome-title">SELECT A SCROLL</div>
          <div class="welcome-sub">"In the digital age, true knowledge must be unstoppable."</div>
          <div class="welcome-pillars">
            <div class="pillar">âœ“ No chain indexing</div>
            <div class="pillar">âœ“ No gatekeepers</div>
            <div class="pillar">âœ“ Forever-readable</div>
            <div class="pillar">âœ“ Koios-first</div>
          </div>
          <div class="welcome-featured">
            <a href="first-video.html" class="feat-link"><span class="icon">ğŸ¬</span> First Video on Cardano</a>
            <a href="constitution.html" class="feat-link"><span class="icon">âš–ï¸</span> The Constitution</a>
            <a href="bible.html" class="feat-link"><span class="icon">ğŸ“–</span> The Holy Bible</a>
          </div>
          <div class="beacn-credit">Built by <a href="https://x.com/BEACNpool" target="_blank">@BEACNpool</a> Â· <a href="https://github.com/BEACNpool/ledger-scrolls" target="_blank">GitHub</a> Â· MIT License</div>
        </div>

        <!-- Loading overlay -->
        <div class="loading-overlay" id="loading-overlay">
          <div class="spinner"></div>
          <div class="loading-text" id="loading-text">Fetching from Cardanoâ€¦</div>
          <div class="loading-step" id="loading-step"></div>
        </div>

        <!-- Content renderers -->
        <iframe id="content-frame" sandbox="allow-scripts"></iframe>
        <img id="content-image" alt="Scroll image content">
        <div id="content-text"></div>
        <video id="content-video" controls></video>
      </div>

      <!-- Details panel -->
      <div class="details-panel" id="details-panel"></div>

      <!-- Status bar -->
      <div class="status-bar" id="status-bar">
        <span class="status-icon" id="status-icon">ğŸ“¡</span>
        <span id="status-text">Ready</span>
      </div>

    </main>
  </div><!-- body-layout -->
</div><!-- app -->

<!-- â”€â”€â”€ TOAST CONTAINER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="toast-container"></div>

<!-- â”€â”€â”€ SETTINGS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="overlay" id="overlay-settings" onclick="closeIfBg(event,'settings')">
  <div class="panel">
    <div class="panel-header">
      <span class="panel-icon">âš™ï¸</span>
      <span class="panel-title">SETTINGS</span>
      <button class="panel-close" onclick="closePanel('settings')">âœ•</button>
    </div>
    <div class="panel-body">
      <div class="panel-section">
        <div class="panel-section-title">Connection</div>
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:14px;font-family:var(--font-body);">
          This viewer is <strong style="color:var(--gold)">Koios-first</strong> by design. No node or relay required.
        </p>
        <div class="form-group">
          <label class="form-label">ğŸ”‘ Blockfrost API Key (optional failover)</label>
          <input type="password" class="form-input" id="input-blockfrost"
                 placeholder="mainnetXXXXXXXXXXXXXXXX"
                 onchange="saveSettings()">
          <div class="form-hint">Only used if Koios is unavailable or missing datum fields.</div>
        </div>
        <button class="btn btn-secondary" onclick="testConnection()">Test Connection</button>
      </div>

      <div class="panel-section">
        <div class="panel-section-title">Registry (DNS for Scrolls)</div>
        <div class="form-group">
          <label class="form-label">Public Head</label>
          <input type="text" class="form-input" id="input-public-head"
                 value="default" placeholder="default"
                 onchange="saveSettings()">
          <div class="form-hint">Trust anchor. Forks are allowed â€” readers choose which head to follow.</div>
        </div>
        <div class="form-group">
          <label class="form-label">Private Heads (one per line)</label>
          <textarea class="form-input" id="input-private-heads"
                    placeholder="addr1qâ€¦registryâ€¦"
                    onchange="saveSettings()"></textarea>
          <div class="form-hint">Private heads override public on name collisions. Perfect for company/private libraries.</div>
        </div>
        <button class="btn btn-primary" onclick="reloadRegistry()">Confirm & Load Library</button>
      </div>

      <div class="panel-section">
        <div class="panel-section-title">Koios Proxy (optional)</div>
        <div class="form-group">
          <label class="form-label">Proxy URL</label>
          <input type="text" class="form-input" id="input-koios-proxy"
                 placeholder="https://your-koios-proxy.example.com"
                 onchange="saveSettings()">
          <div class="form-hint" id="proxy-current">Current: (none)</div>
        </div>
        <button class="btn btn-secondary" onclick="saveSettings(); toast('Proxy saved', 'success')">Save Proxy</button>
      </div>

      <div class="panel-section">
        <div class="panel-section-title">Theme</div>
        <div class="theme-grid">
          <div class="theme-opt active" id="theme-dark" onclick="setTheme('dark')">
            <div class="theme-swatch swatch-dark">ğŸŒ™</div>
            Dark
          </div>
          <div class="theme-opt" id="theme-light" onclick="setTheme('light')">
            <div class="theme-swatch swatch-light">â˜€ï¸</div>
            Light
          </div>
          <div class="theme-opt" id="theme-parchment" onclick="setTheme('parchment')">
            <div class="theme-swatch swatch-parchment">ğŸ“œ</div>
            Parchment
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ ABOUT PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="overlay center" id="overlay-about" onclick="closeIfBg(event,'about')">
  <div class="panel" style="max-width:500px;">
    <div class="panel-header">
      <span class="panel-icon">ğŸ“œ</span>
      <span class="panel-title">ABOUT</span>
      <button class="panel-close" onclick="closePanel('about')">âœ•</button>
    </div>
    <div class="panel-body">
      <div class="about-hero">
        <span class="about-glyph">ğŸ“œ</span>
        <div class="about-title">LEDGER SCROLLS</div>
        <div class="about-tagline">"A Library That Cannot Burn"</div>
      </div>

      <div class="panel-section">
        <div class="panel-section-title">What is this?</div>
        <p style="font-size:14px;color:var(--text-dim);font-family:var(--font-body);line-height:1.7;">
          A viewer for <strong style="color:var(--text)">immutable documents</strong> stored on the Cardano blockchain.
          Once published, scrolls exist forever â€” as long as Cardano exists.
        </p>
      </div>

      <div class="panel-section">
        <div class="panel-section-title">Design Principles</div>
        <div class="principle-list">
          <div class="principle"><div class="principle-dot"></div>No chain indexing required</div>
          <div class="principle"><div class="principle-dot"></div>No centralized gatekeepers</div>
          <div class="principle"><div class="principle-dot"></div>No "download the whole chain"</div>
          <div class="principle"><div class="principle-dot"></div>Forever-readable by design</div>
          <div class="principle"><div class="principle-dot"></div>Koios-first, Blockfrost as failover</div>
        </div>
      </div>

      <div class="panel-section">
        <div class="panel-section-title">Featured</div>
        <div class="about-links">
          <a href="first-video.html" class="about-link">
            <span class="icon">ğŸ¬</span>
            <div>
              <span class="about-link-title">First Video on Cardano</span>
              <span class="about-link-sub">Watch history unfold as the first video stored on-chain plays in your browser.</span>
            </div>
          </a>
          <a href="constitution.html" class="about-link">
            <span class="icon">âš–ï¸</span>
            <div>
              <span class="about-link-title">The Cardano Constitution</span>
              <span class="about-link-sub">The founding governance document, fetched directly from on-chain storage.</span>
            </div>
          </a>
          <a href="bible.html" class="about-link">
            <span class="icon">ğŸ“–</span>
            <div>
              <span class="about-link-title">The Holy Bible</span>
              <span class="about-link-sub">Complete World English Bible â€” 66 books, ~3,500 years of history preserved forever.</span>
            </div>
          </a>
        </div>
      </div>

      <div class="about-footer">
        Built with â¤ï¸ by <a href="https://x.com/BEACNpool" target="_blank">@BEACNpool</a>
        &nbsp;Â·&nbsp;
        <a href="https://github.com/BEACNpool/ledger-scrolls" target="_blank">GitHub</a>
        &nbsp;Â·&nbsp;
        MIT License
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ CUSTOM SCROLL PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="overlay" id="overlay-custom" onclick="closeIfBg(event,'custom')">
  <div class="panel">
    <div class="panel-header">
      <span class="panel-icon">ğŸ”§</span>
      <span class="panel-title">LOAD CUSTOM SCROLL</span>
      <button class="panel-close" onclick="closePanel('custom')">âœ•</button>
    </div>
    <div class="panel-body">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('standard')">Standard (UTxO)</button>
        <button class="tab-btn" onclick="switchTab('legacy')">Legacy (NFT Pages)</button>
      </div>

      <!-- Standard tab -->
      <div class="tab-pane active" id="tab-standard">
        <div class="form-group">
          <label class="form-label">Lock Address (optional)</label>
          <input type="text" class="form-input" id="custom-lock-address" placeholder="addr1wâ€¦">
        </div>
        <div class="form-group">
          <label class="form-label">Transaction Input (txhash#index) *</label>
          <input type="text" class="form-input" id="custom-txin" placeholder="abc123â€¦#0">
        </div>
        <div class="form-group">
          <label class="form-label">Content Type</label>
          <select class="form-input" id="custom-content-type">
            <option value="image/png">Image (PNG)</option>
            <option value="image/jpeg">Image (JPEG)</option>
            <option value="text/html">HTML</option>
            <option value="text/plain">Plain Text</option>
            <option value="application/pdf">PDF</option>
            <option value="video/mp4">Video (MP4)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Codec</label>
          <select class="form-input" id="custom-codec">
            <option value="none">None</option>
            <option value="gzip">Gzip</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Expected SHA256 (optional)</label>
          <input type="text" class="form-input" id="custom-sha256" placeholder="abc123â€¦">
        </div>
        <button class="btn btn-primary btn-full" onclick="loadCustomStandard()">Load Scroll</button>
      </div>

      <!-- Legacy tab -->
      <div class="tab-pane" id="tab-legacy">
        <div class="form-group">
          <label class="form-label">Policy ID *</label>
          <input type="text" class="form-input" id="legacy-policy" placeholder="2f0c8b54ef86ffâ€¦">
        </div>
        <div class="form-group">
          <label class="form-label">Manifest TX Hash *</label>
          <input type="text" class="form-input" id="legacy-manifest-tx" placeholder="cfda418ddc84â€¦">
        </div>
        <div class="form-group">
          <label class="form-label">Content Type</label>
          <select class="form-input" id="legacy-content-type">
            <option value="text/html">HTML</option>
            <option value="text/plain">Plain Text</option>
            <option value="application/pdf">PDF</option>
            <option value="video/mp4">Video (MP4)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Codec</label>
          <select class="form-input" id="legacy-codec">
            <option value="gzip">Gzip</option>
            <option value="none">None</option>
          </select>
        </div>
        <button class="btn btn-primary btn-full" onclick="loadCustomLegacy()">Load Scroll</button>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ VERIFY PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="overlay center" id="overlay-verify" onclick="closeIfBg(event,'verify')">
  <div class="panel" style="max-width:480px;">
    <div class="panel-header">
      <span class="panel-icon">ğŸ”</span>
      <span class="panel-title">VERIFICATION</span>
      <button class="panel-close" onclick="closePanel('verify')">âœ•</button>
    </div>
    <div class="panel-body">
      <div class="panel-section">
        <div class="panel-section-title">On-Chain Hash Check</div>
        <p style="font-size:13px;color:var(--text-dim);font-family:var(--font-body);margin-bottom:14px;">
          Verify that the content you see exactly matches what is stored on Cardano.
        </p>
        <div class="form-group">
          <label class="form-label">Expected SHA256 (from scroll metadata)</label>
          <input type="text" class="form-input" id="verify-expected" placeholder="Leave blank to use scroll's declared hash">
        </div>
        <button class="btn btn-primary btn-full" onclick="runVerification()">ğŸ” Verify Now</button>
        <div class="verify-result" id="verify-result"></div>
      </div>
      <div class="panel-section" id="verify-details-section" style="display:none;">
        <div class="panel-section-title">Current Scroll Info</div>
        <div id="verify-scroll-info" style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim);line-height:2;"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEDGER SCROLLS VIEWER â€” Core Application
   BEACNpool Â· MIT License Â· https://github.com/BEACNpool/ledger-scrolls
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const CFG = {
  koiosBase:        'https://api.koios.rest/api/v1',
  blockfrostBase:   'https://cardano-mainnet.blockfrost.io/api/v0',
  registryPolicy:   '895cbbe0e284b60660ed681e389329483d5ca94677cbb583f3124062',
  registryAsset:    '4c535f5245474953545259', // LS_REGISTRY
  registryAddress:  'addr1q9x84f458uyf3k23sr7qfalg3mw2hl0nvv4navps2r7vq69esnxrheg9tfpr8sdyfzpr8jch5p538xjynz78lql9wm6qpl6qxy',
};

const State = {
  scrolls: [],
  currentIdx: -1,
  currentBytes: null,
  currentScroll: null,
  settings: {
    blockfrostKey: '',
    koiosProxy: '',
    publicHead: 'default',
    privateHeads: '',
    theme: 'dark',
  },
};

/* â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function hexToBytes(hex) {
  hex = hex.replace(/\s/g,'');
  const len = hex.length;
  const arr = new Uint8Array(len / 2);
  for (let i = 0; i < len; i += 2) arr[i/2] = parseInt(hex.substr(i,2), 16);
  return arr;
}

function bytesToHex(bytes) {
  return Array.from(bytes).map(b => b.toString(16).padStart(2,'0')).join('');
}

async function sha256Hex(bytes) {
  const buf = await crypto.subtle.digest('SHA-256', bytes);
  return bytesToHex(new Uint8Array(buf));
}

function gunzip(bytes) {
  try { return pako.inflate(bytes); } catch(e) {
    try { return pako.ungzip(bytes); } catch(e2) { throw new Error('Decompression failed'); }
  }
}

function extractBytesFromDatum(datum) {
  if (!datum) return null;
  // Handle various Koios/Blockfrost datum shapes
  if (typeof datum === 'string') {
    // Try as CBOR byte string
    const raw = hexToBytes(datum);
    if (!raw.length) return null;
    const tag = raw[0];
    // CBOR major type 2 (byte string): 0x40â€“0x57, 0x58, 0x59, 0x5a, 0x5b
    if (tag >= 0x40 && tag <= 0x57) return raw.slice(1, 1 + (tag - 0x40));
    if (tag === 0x58) return raw.slice(2, 2 + raw[1]);
    if (tag === 0x59) return raw.slice(3, 3 + ((raw[1]<<8)|raw[2]));
    if (tag === 0x5a) return raw.slice(5, 5 + ((raw[1]<<24)|(raw[2]<<16)|(raw[3]<<8)|raw[4]));
    if (tag === 0x5f) {
      // indefinite length byte string: collect chunks
      let i = 1, chunks = [];
      while (i < raw.length && raw[i] !== 0xff) {
        const ct = raw[i];
        if (ct >= 0x40 && ct <= 0x57) { const l = ct-0x40; chunks.push(raw.slice(i+1,i+1+l)); i+=1+l; }
        else if (ct === 0x58) { const l = raw[i+1]; chunks.push(raw.slice(i+2,i+2+l)); i+=2+l; }
        else if (ct === 0x59) { const l=(raw[i+1]<<8)|raw[i+2]; chunks.push(raw.slice(i+3,i+3+l)); i+=3+l; }
        else break;
      }
      const total = chunks.reduce((s,c)=>s+c.length,0);
      const out = new Uint8Array(total);
      let off=0; for(const c of chunks){out.set(c,off);off+=c.length;}
      return out;
    }
    // Not CBOR â€” return raw (might be bare hex bytes)
    return raw;
  }
  if (typeof datum === 'object') {
    if (datum.bytes) return hexToBytes(datum.bytes);
    if (datum.value?.bytes) return hexToBytes(datum.value.bytes);
    if (datum.value?.int !== undefined) return null; // int datum, not bytes
    if (datum.value?.list) return null;
    if (datum.value?.map) return null;
    // Blockfrost inline_datum shape
    if (datum.json_value?.bytes) return hexToBytes(datum.json_value.bytes);
  }
  return null;
}

/* â”€â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function koiosFetch(path, body, method='POST') {
  const base = State.settings.koiosProxy || CFG.koiosBase;
  const url = base.replace(/\/$/, '') + path;
  const opts = {
    method, headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }
  };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(url, opts);
  if (!res.ok) throw new Error(`Koios ${res.status}: ${res.statusText}`);
  return res.json();
}

async function koiosGet(path) {
  const base = State.settings.koiosProxy || CFG.koiosBase;
  const url = base.replace(/\/$/, '') + path;
  const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
  if (!res.ok) throw new Error(`Koios ${res.status}: ${res.statusText}`);
  return res.json();
}

async function bfFetch(path) {
  const key = State.settings.blockfrostKey;
  if (!key) throw new Error('No Blockfrost key configured');
  const res = await fetch(CFG.blockfrostBase + path, {
    headers: { 'project_id': key, 'Accept': 'application/json' }
  });
  if (!res.ok) throw new Error(`Blockfrost ${res.status}: ${res.statusText}`);
  return res.json();
}

/* â”€â”€â”€ ADDRESS UTxOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function fetchAddressUtxos(address) {
  try {
    const data = await koiosFetch('/address_utxos', { _addresses: [address] });
    return data;
  } catch(e) {
    // Fallback to Blockfrost
    const data = await bfFetch(`/addresses/${address}/utxos`);
    return data;
  }
}

/* â”€â”€â”€ TX METADATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function fetchTxMetadata(txHash) {
  try {
    const data = await koiosFetch('/tx_metadata', { _tx_hashes: [txHash] });
    // Koios returns [{tx_hash, metadata:{label:{...}}}]
    if (data && data.length > 0) return data[0].metadata || {};
    return {};
  } catch(e) {
    // Blockfrost fallback
    const data = await bfFetch(`/txs/${txHash}/metadata`);
    // Blockfrost returns [{label, json_metadata}]
    const out = {};
    for (const m of data) out[m.label] = m.json_metadata;
    return out;
  }
}

/* â”€â”€â”€ ASSET POLICY UTxOs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function fetchAssetUtxos(policyId, assetName) {
  const asset = policyId + assetName;
  try {
    const data = await koiosFetch('/asset_utxos', {
      _asset_list: [[policyId, assetName]], _extended: true
    });
    return data || [];
  } catch(e) {
    // Blockfrost: asset_name as hex
    const data = await bfFetch(`/assets/${asset}/addresses`);
    return data;
  }
}

/* â”€â”€â”€ REGISTRY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadRegistry() {
  setConnection('connecting');
  setStep('Querying registry addressâ€¦');

  try {
    const utxos = await fetchAddressUtxos(CFG.registryAddress);
    // Find UTxO containing the registry NFT
    let regUtxo = null;
    for (const u of (utxos || [])) {
      const assets = u.asset_list || u.amount || [];
      const hasReg = assets.some(a => {
        const pid = a.policy_id || a.unit?.slice(0,56);
        const aname = a.asset_name || a.unit?.slice(56);
        return pid === CFG.registryPolicy &&
               (aname === CFG.registryAsset || (a.unit === CFG.registryPolicy + CFG.registryAsset));
      });
      if (hasReg) { regUtxo = u; break; }
    }

    if (!regUtxo && utxos?.length > 0) {
      // Use first UTxO with inline datum if asset filter fails
      regUtxo = utxos.find(u => u.inline_datum) || utxos[0];
    }

    if (!regUtxo) throw new Error('Registry UTxO not found');

    setStep('Decoding registry datumâ€¦');
    const datumRaw = regUtxo.inline_datum;
    const bytes = extractBytesFromDatum(datumRaw);
    if (!bytes) throw new Error('Could not extract bytes from registry datum');

    const decompressed = gunzip(bytes);
    const json = JSON.parse(new TextDecoder().decode(decompressed));

    setConnection('online');
    return json.scrolls || [];
  } catch(e) {
    console.warn('Registry load failed:', e);
    setConnection('error');
    return getFallbackScrolls();
  }
}

function getFallbackScrolls() {
  return [
    {
      id: 'hosky-png',
      title: 'Hosky PNG (Standard)',
      type: 'utxo_datum_bytes_v1',
      lock_address: 'addr1w8qvvu0m5jpkgxn3hwfd829hc5kfp0cuq83tsvgk44752dsea0svn',
      lock_txin: '728660515c6d9842d9f0ffd273f2b487a4070fd9f4bd5455a42e3a56880389be#0',
      content_type: 'image/png',
      codec: 'none',
      sha256: '798e3296d45bb42e7444dbf64e1eb16b02c86a233310407e7d8baf97277f642f',
    },
    {
      id: 'bible',
      title: 'Bible (HTML, gzip compressed)',
      type: 'cip25_pages_v1',
      policy_id: '2f0c8b54ef86ffcdd95ba87360ca5b485a8da4f085ded7988afc77e0',
      manifest_tx_hash: 'cfda418ddc84888ac39116ffba691a4f90b3232f4c2633cd56f102cfebda0ee4',
      manifest_slot: '175750638',
      codec: 'gzip',
      content_type: 'text/html',
      segments_per_page: 32,
    },
    {
      id: 'bitcoin-whitepaper',
      title: 'Bitcoin Whitepaper',
      type: 'cip25_pages_v1',
      policy_id: '8dc3cb836ab8134c75e369391b047f5c2bf796df10d9bf44a33ef6d1',
      manifest_tx_hash: '2575347068f77b21cfe8d9c23d9082a68bfe4ef7ba7a96608af90515acbe228f',
      manifest_slot: '176360887',
      codec: 'none',
      content_type: 'text/plain',
    },
  ];
}

/* â”€â”€â”€ STANDARD SCROLL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadStandardScroll(scroll) {
  setStep('Querying lock addressâ€¦');
  const addr = scroll.lock_address;
  const txin = scroll.lock_txin;

  let utxos;
  try {
    utxos = await fetchAddressUtxos(addr);
  } catch(e) {
    throw new Error('Failed to fetch UTxOs: ' + e.message);
  }

  // Find the specific UTxO
  let target = null;
  if (txin) {
    const [txHash, idxStr] = txin.split('#');
    const idx = parseInt(idxStr, 10);
    target = (utxos || []).find(u =>
      (u.tx_hash === txHash && u.tx_index === idx) ||
      (u.tx_hash === txHash && u.output_index === idx)
    );
  }
  if (!target && utxos?.length > 0) {
    target = utxos.find(u => u.inline_datum) || utxos[0];
  }
  if (!target) throw new Error('Target UTxO not found on chain');

  setStep('Extracting datum bytesâ€¦');
  const datumRaw = target.inline_datum;
  let bytes = extractBytesFromDatum(datumRaw);
  if (!bytes || !bytes.length) throw new Error('No bytes in datum. UTxO may have wrong format.');

  if (scroll.codec === 'gzip') {
    setStep('Decompressingâ€¦');
    bytes = gunzip(bytes);
  }

  return bytes;
}

/* â”€â”€â”€ LEGACY SCROLL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadLegacyScroll(scroll) {
  setStep('Fetching manifest metadataâ€¦');
  const metadata = await fetchTxMetadata(scroll.manifest_tx_hash);
  
  // Find manifest in metadata (label 721 for CIP-25, or any label)
  let manifest = null;
  for (const label of Object.keys(metadata)) {
    const v = metadata[label];
    if (v && typeof v === 'object') {
      // Try top-level or nested under policy
      const candidate = v[scroll.policy_id] || v;
      if (candidate && (candidate.spec || candidate.role === 'manifest' || candidate.n || candidate.pages)) {
        manifest = candidate;
        break;
      }
      // Also check if it's the manifest itself
      if (v.spec || v.role === 'manifest' || (v.n && v.codec)) {
        manifest = v;
        break;
      }
    }
  }
  
  if (!manifest) {
    // Try to treat metadata itself as manifest or use first value
    const vals = Object.values(metadata);
    if (vals.length > 0) manifest = vals[0];
    else throw new Error('Could not find manifest in transaction metadata');
  }

  const totalPages = manifest.n || manifest.pages || manifest.total_pages || 1;
  const codec = scroll.codec || manifest.codec || 'none';
  
  setStep(`Fetching ${totalPages} page(s)â€¦`);

  // Gather page metadata â€” pages are NFTs from the same policy
  // Each page's metadata is in its mint tx, indexed by asset name
  // We need to find all page txs. Strategy:
  // 1. If manifest has explicit page_txs list, use those
  // 2. Otherwise query asset_utxos for each page asset
  
  const pageChunks = [];
  
  if (manifest.pages && Array.isArray(manifest.pages)) {
    // Explicit page list
    for (let i = 0; i < manifest.pages.length; i++) {
      const page = manifest.pages[i];
      setStep(`Fetching page ${i+1}/${manifest.pages.length}â€¦`);
      const pageMeta = await fetchTxMetadata(page.tx_hash || page.hash);
      const pageData = extractPagePayload(pageMeta, scroll.policy_id, i+1);
      pageChunks.push(...pageData);
    }
  } else {
    // Reconstruct page asset names from policy and find their metadata
    // Common naming: policyId.MANIFEST, policyId.PAGE_1, policyId.PAGE_2 etc.
    // Or numeric: 001, 002, etc.
    // We'll try to get them from asset_utxos
    for (let p = 1; p <= totalPages; p++) {
      setStep(`Fetching page ${p}/${totalPages}â€¦`);
      try {
        const meta = await fetchPageByIndex(scroll.policy_id, p, manifest);
        if (meta) pageChunks.push(...meta);
      } catch(e) {
        console.warn(`Page ${p} failed:`, e);
      }
    }
  }

  if (!pageChunks.length) throw new Error('No page content could be fetched');

  setStep('Reconstructing documentâ€¦');
  // Concatenate all chunks
  const totalLen = pageChunks.reduce((s, c) => s + c.length, 0);
  const combined = new Uint8Array(totalLen);
  let offset = 0;
  for (const chunk of pageChunks) { combined.set(chunk, offset); offset += chunk.length; }

  if (codec === 'gzip') {
    setStep('Decompressingâ€¦');
    return gunzip(combined);
  }
  return combined;
}

async function fetchPageByIndex(policyId, pageNum, manifest) {
  // Try to fetch page by querying asset UTxOs
  // Asset name format varies â€” try common patterns
  const patterns = [
    pageNum.toString().padStart(4,'0'),
    pageNum.toString().padStart(3,'0'),
    `PAGE_${pageNum}`,
    `page${pageNum}`,
    pageNum.toString(),
  ];
  
  for (const pattern of patterns) {
    const assetNameHex = stringToHex(pattern);
    try {
      const utxos = await fetchAssetUtxos(policyId, assetNameHex);
      if (utxos && utxos.length > 0) {
        // Found! Get the mint tx metadata
        const u = utxos[0];
        const txHash = u.tx_hash || u.created_at_tx_hash;
        if (txHash) {
          const meta = await fetchTxMetadata(txHash);
          return extractPagePayload(meta, policyId, pageNum);
        }
      }
    } catch(e) { /* try next pattern */ }
  }
  return [];
}

function extractPagePayload(metadata, policyId, pageNum) {
  const chunks = [];
  // Walk through all metadata labels looking for page data
  for (const label of Object.keys(metadata)) {
    const v = metadata[label];
    // Find the page data under policy or at top level
    const candidates = [
      v?.[policyId],
      v,
      Object.values(v || {}).find(x => x && (x.role === 'page' || x.i === pageNum || x.payload)),
    ].filter(Boolean);
    
    for (const c of candidates) {
      const payload = c.payload || c.seg || c.segments;
      if (!payload) continue;
      const segs = Array.isArray(payload) ? payload : [payload];
      for (const seg of segs) {
        if (typeof seg === 'string') chunks.push(hexToBytes(seg));
        else if (Array.isArray(seg)) {
          for (const s of seg) if (typeof s === 'string') chunks.push(hexToBytes(s));
        }
      }
      if (chunks.length > 0) return chunks;
    }
  }
  return chunks;
}

function stringToHex(str) {
  return Array.from(str).map(c => c.charCodeAt(0).toString(16).padStart(2,'0')).join('');
}

/* â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderContent(bytes, contentType, scroll) {
  // Hide all renderers
  document.getElementById('content-frame').style.display = 'none';
  document.getElementById('content-image').style.display = 'none';
  document.getElementById('content-text').style.display = 'none';
  document.getElementById('content-video').style.display = 'none';
  document.getElementById('welcome').style.display = 'none';

  const blob = new Blob([bytes], { type: contentType });
  const url = URL.createObjectURL(blob);

  if (contentType.startsWith('image/')) {
    const img = document.getElementById('content-image');
    img.src = url;
    img.style.display = 'block';
    document.getElementById('content-area').style.display = 'flex';
    document.getElementById('content-area').style.alignItems = 'center';
    document.getElementById('content-area').style.justifyContent = 'center';
  } else if (contentType === 'text/html') {
    const frame = document.getElementById('content-frame');
    frame.src = url;
    frame.style.display = 'block';
    document.getElementById('content-area').style.alignItems = '';
    document.getElementById('content-area').style.justifyContent = '';
  } else if (contentType === 'text/plain') {
    const text = document.getElementById('content-text');
    const decoder = new TextDecoder();
    text.textContent = decoder.decode(bytes);
    text.style.display = 'block';
    document.getElementById('content-area').style.alignItems = '';
    document.getElementById('content-area').style.justifyContent = '';
  } else if (contentType === 'video/mp4') {
    const vid = document.getElementById('content-video');
    vid.src = url;
    vid.style.display = 'block';
    document.getElementById('content-area').style.alignItems = '';
    document.getElementById('content-area').style.justifyContent = '';
  } else if (contentType === 'application/pdf') {
    const frame = document.getElementById('content-frame');
    frame.src = url;
    frame.style.display = 'block';
    document.getElementById('content-area').style.alignItems = '';
    document.getElementById('content-area').style.justifyContent = '';
  }

  // Update details
  State.currentBytes = bytes;
  updateDetailsPanel(scroll, bytes);
}

async function updateDetailsPanel(scroll, bytes) {
  const hash = await sha256Hex(bytes);
  const panel = document.getElementById('details-panel');
  const rows = [
    ['id', scroll.id || 'â€”'],
    ['type', scroll.type || 'â€”'],
    ['content-type', scroll.content_type || 'â€”'],
    ['codec', scroll.codec || 'none'],
    ['size', (bytes.length / 1024).toFixed(1) + ' KB'],
    ['sha256-actual', hash],
    ...(scroll.sha256 ? [['sha256-declared', scroll.sha256],['match', hash === scroll.sha256 ? 'âœ“ VERIFIED' : 'âœ— MISMATCH']] : []),
    ...(scroll.lock_txin ? [['txin', scroll.lock_txin]] : []),
    ...(scroll.policy_id ? [['policy', scroll.policy_id]] : []),
  ];
  panel.innerHTML = rows.map(([k,v]) => {
    let cls = 'detail-val';
    if (k === 'sha256-actual' || k === 'txin' || k === 'policy') cls += ' hash';
    if (k === 'match' && v.startsWith('âœ“')) cls += ' match';
    if (k === 'match' && v.startsWith('âœ—')) cls += ' mismatch';
    return `<div class="detail-row"><span class="detail-key">${k}</span><span class="${cls}">${v}</span></div>`;
  }).join('');
}

/* â”€â”€â”€ SCROLL OPEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function openScroll(idx) {
  const scroll = State.scrolls[idx];
  if (!scroll) return;
  State.currentIdx = idx;
  State.currentScroll = scroll;

  // Update sidebar active state
  document.querySelectorAll('.scroll-item').forEach((el,i) => {
    el.classList.toggle('active', i === idx);
  });
  document.getElementById('scroll-idx').textContent = idx + 1;

  // Update viewer header
  document.getElementById('welcome').style.display = 'none';
  document.getElementById('viewer-header').classList.add('visible');
  document.getElementById('viewer-title').textContent = scroll.title || scroll.id;
  
  const isStd = scroll.type === 'utxo_datum_bytes_v1';
  document.getElementById('viewer-scroll-icon').textContent = isStd ? 'ğŸ“„' : 'ğŸ“š';

  // Show loading
  showLoading(true);
  setLoadingText('Fetching from Cardano blockchainâ€¦');

  try {
    let bytes;
    if (isStd) {
      bytes = await loadStandardScroll(scroll);
    } else {
      bytes = await loadLegacyScroll(scroll);
    }
    showLoading(false);
    renderContent(bytes, scroll.content_type || 'text/plain', scroll);
    toast(`Loaded: ${scroll.title}`, 'success');
    setStatus('âœ“ ' + scroll.title + ' loaded from chain', 'âœ…');
  } catch(e) {
    showLoading(false);
    console.error(e);
    toast('Error: ' + e.message, 'error');
    setStatus('Error: ' + e.message, 'âŒ');
    showWelcome();
  }

  updateNav();
}

function showWelcome() {
  document.getElementById('welcome').style.display = 'flex';
  document.getElementById('content-frame').style.display = 'none';
  document.getElementById('content-image').style.display = 'none';
  document.getElementById('content-text').style.display = 'none';
  document.getElementById('content-video').style.display = 'none';
}

/* â”€â”€â”€ REGISTRY RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function renderScrollList(scrolls) {
  State.scrolls = scrolls;
  const list = document.getElementById('scroll-list');
  if (!scrolls.length) {
    list.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-muted);font-family:var(--font-mono);font-size:11px;">No scrolls found in registry.</div>';
    return;
  }
  list.innerHTML = scrolls.map((s, i) => {
    const isStd = s.type === 'utxo_datum_bytes_v1';
    const ct = (s.content_type || '').split('/')[1] || s.content_type || '?';
    return `
    <div class="scroll-item" onclick="openScroll(${i})">
      <div class="scroll-item-title">${s.title || s.id}</div>
      <div class="scroll-item-meta">
        <span class="badge ${isStd ? 'badge-standard' : 'badge-legacy'}">${isStd ? 'Standard' : 'Legacy'}</span>
        <span class="badge-type">${ct} Â· ${s.codec || 'raw'}</span>
      </div>
    </div>`;
  }).join('');
  document.getElementById('scroll-total').textContent = scrolls.length;
  updateNav();
}

/* â”€â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function navigate(dir) {
  const newIdx = State.currentIdx + dir;
  if (newIdx >= 0 && newIdx < State.scrolls.length) openScroll(newIdx);
}

function updateNav() {
  const n = State.scrolls.length;
  document.getElementById('btn-prev').disabled = State.currentIdx <= 0;
  document.getElementById('btn-next').disabled = State.currentIdx >= n - 1 || n === 0;
}

/* â”€â”€â”€ CUSTOM SCROLL LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadCustomStandard() {
  const scroll = {
    id: 'custom-standard',
    title: 'Custom Standard Scroll',
    type: 'utxo_datum_bytes_v1',
    lock_address: document.getElementById('custom-lock-address').value.trim(),
    lock_txin: document.getElementById('custom-txin').value.trim(),
    content_type: document.getElementById('custom-content-type').value,
    codec: document.getElementById('custom-codec').value,
    sha256: document.getElementById('custom-sha256').value.trim() || null,
  };
  if (!scroll.lock_address && !scroll.lock_txin) {
    toast('Please provide lock address or txin', 'error'); return;
  }
  if (!scroll.lock_address && scroll.lock_txin) {
    // If only txin provided, we need an address to query.
    // Use a Koios tx_info lookup instead
    toast('âš ï¸ Lock address required for direct lookup', 'error'); return;
  }
  closePanel('custom');
  const tempIdx = State.scrolls.length;
  State.scrolls.push(scroll);
  renderScrollList(State.scrolls);
  openScroll(tempIdx);
}

async function loadCustomLegacy() {
  const scroll = {
    id: 'custom-legacy',
    title: 'Custom Legacy Scroll',
    type: 'cip25_pages_v1',
    policy_id: document.getElementById('legacy-policy').value.trim(),
    manifest_tx_hash: document.getElementById('legacy-manifest-tx').value.trim(),
    content_type: document.getElementById('legacy-content-type').value,
    codec: document.getElementById('legacy-codec').value,
  };
  if (!scroll.policy_id || !scroll.manifest_tx_hash) {
    toast('Policy ID and Manifest TX Hash required', 'error'); return;
  }
  closePanel('custom');
  const tempIdx = State.scrolls.length;
  State.scrolls.push(scroll);
  renderScrollList(State.scrolls);
  openScroll(tempIdx);
}

/* â”€â”€â”€ VERIFICATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function runVerification() {
  const scroll = State.currentScroll;
  const bytes = State.currentBytes;
  if (!bytes) { toast('No scroll loaded', 'error'); return; }

  const expectedInput = document.getElementById('verify-expected').value.trim();
  const expected = expectedInput || (scroll && scroll.sha256);
  const actual = await sha256Hex(bytes);

  const resultEl = document.getElementById('verify-result');
  if (!expected) {
    resultEl.className = 'verify-result fail';
    resultEl.innerHTML = `<strong>No expected hash available.</strong><br><div class="verify-hash">Actual SHA256: ${actual}</div>`;
    return;
  }

  if (actual === expected.toLowerCase()) {
    resultEl.className = 'verify-result pass';
    resultEl.innerHTML = `<strong>âœ“ VERIFIED â€” Content matches on-chain declaration</strong><br><div class="verify-hash">SHA256: ${actual}</div>`;
  } else {
    resultEl.className = 'verify-result fail';
    resultEl.innerHTML = `<strong>âœ— MISMATCH â€” Content does not match</strong><br><div class="verify-hash">Expected: ${expected}<br>Actual: &nbsp;&nbsp;${actual}</div>`;
  }

  // Show scroll info
  if (scroll) {
    const infoEl = document.getElementById('verify-scroll-info');
    document.getElementById('verify-details-section').style.display = '';
    infoEl.innerHTML = [
      ['Title', scroll.title || scroll.id],
      ['Type', scroll.type],
      ['Content-Type', scroll.content_type],
      ['Size', (bytes.length/1024).toFixed(1)+' KB'],
      ...(scroll.lock_txin ? [['TxIn', scroll.lock_txin]] : []),
      ...(scroll.policy_id ? [['Policy', scroll.policy_id]] : []),
    ].map(([k,v]) => `<div><span style="color:var(--text-muted);min-width:100px;display:inline-block;">${k}:</span> ${v}</div>`).join('');
  }
}

/* â”€â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function loadSettings() {
  try {
    const s = JSON.parse(localStorage.getItem('ls-settings') || '{}');
    Object.assign(State.settings, s);
  } catch(e) {}
  document.getElementById('input-blockfrost').value = State.settings.blockfrostKey || '';
  document.getElementById('input-koios-proxy').value = State.settings.koiosProxy || '';
  document.getElementById('input-public-head').value = State.settings.publicHead || 'default';
  document.getElementById('input-private-heads').value = State.settings.privateHeads || '';
  if (State.settings.koiosProxy) {
    document.getElementById('proxy-current').textContent = 'Current: ' + State.settings.koiosProxy;
  }
  setTheme(State.settings.theme || 'dark', false);
}

function saveSettings() {
  State.settings.blockfrostKey = document.getElementById('input-blockfrost').value.trim();
  State.settings.koiosProxy = document.getElementById('input-koios-proxy').value.trim();
  State.settings.publicHead = document.getElementById('input-public-head').value.trim() || 'default';
  State.settings.privateHeads = document.getElementById('input-private-heads').value.trim();
  const proxy = State.settings.koiosProxy;
  document.getElementById('proxy-current').textContent = proxy ? 'Current: ' + proxy : 'Current: (none)';
  localStorage.setItem('ls-settings', JSON.stringify(State.settings));
}

async function reloadRegistry() {
  saveSettings();
  closePanel('settings');
  const list = document.getElementById('scroll-list');
  list.innerHTML = '<div style="padding:32px;text-align:center;color:var(--text-muted);font-family:var(--font-mono);font-size:11px;"><div style="font-size:28px;margin-bottom:12px;">â³</div>Loading registryâ€¦</div>';
  const scrolls = await loadRegistry();
  await renderScrollList(scrolls);
}

async function testConnection() {
  saveSettings();
  setConnection('connecting');
  try {
    const data = await koiosGet('/tip');
    setConnection('online');
    const tip = data[0] || data;
    toast(`Connected Â· Epoch ${tip.epoch_no || '?'} Â· Block ${(tip.block_height||'?').toLocaleString()}`, 'success');
  } catch(e) {
    setConnection('error');
    toast('Koios unreachable: ' + e.message, 'error');
  }
}

/* â”€â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setTheme(theme, save=true) {
  document.documentElement.setAttribute('data-theme', theme);
  State.settings.theme = theme;
  document.querySelectorAll('.theme-opt').forEach(el => {
    el.classList.toggle('active', el.id === 'theme-' + theme);
  });
  if (save) {
    State.settings.theme = theme;
    localStorage.setItem('ls-settings', JSON.stringify(State.settings));
  }
}

/* â”€â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setConnection(state) {
  const badge = document.getElementById('conn-badge');
  const text = document.getElementById('conn-text');
  badge.className = 'conn-badge ' + state;
  const labels = { connecting: 'Connectingâ€¦', online: 'Koios Â· Online', error: 'Koios Â· Error', offline: 'Offline' };
  text.textContent = labels[state] || state;
}

function showLoading(show) {
  document.getElementById('loading-overlay').classList.toggle('visible', show);
}

function setLoadingText(txt) {
  document.getElementById('loading-text').textContent = txt;
}

function setStep(step) {
  document.getElementById('loading-step').textContent = step;
}

function toggleDetails() {
  const panel = document.getElementById('details-panel');
  const btn = document.getElementById('btn-details');
  panel.classList.toggle('visible');
  btn.textContent = panel.classList.contains('visible') ? 'Details â–´' : 'Details â–¾';
}

function setStatus(msg, icon='ğŸ“¡') {
  document.getElementById('status-text').textContent = msg;
  document.getElementById('status-icon').textContent = icon;
  document.getElementById('status-bar').classList.add('visible');
}

function toast(msg, type='') {
  const c = document.getElementById('toast-container');
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.textContent = msg;
  c.appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

function openPanel(name) {
  document.querySelectorAll('.overlay').forEach(el => el.classList.remove('visible'));
  const el = document.getElementById('overlay-' + name);
  if (el) {
    el.classList.add('visible');
    document.body.style.overflow = 'hidden';
  }
  // Populate verify info if opening verify panel
  if (name === 'verify' && State.currentScroll) {
    document.getElementById('verify-expected').value = State.currentScroll.sha256 || '';
    document.getElementById('verify-result').className = 'verify-result';
  }
}

function closePanel(name) {
  const el = document.getElementById('overlay-' + name);
  if (el) el.classList.remove('visible');
  document.body.style.overflow = '';
}

function closeIfBg(event, name) {
  if (event.target === event.currentTarget) closePanel(name);
}

function switchTab(which) {
  document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', i === (which==='standard'?0:1)));
  document.getElementById('tab-standard').classList.toggle('active', which === 'standard');
  document.getElementById('tab-legacy').classList.toggle('active', which === 'legacy');
}

/* â”€â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.querySelectorAll('.overlay').forEach(el => el.classList.remove('visible'));
  if (e.key === 'ArrowLeft' && !e.target.matches('input,textarea')) navigate(-1);
  if (e.key === 'ArrowRight' && !e.target.matches('input,textarea')) navigate(1);
});

/* â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function boot() {
  loadSettings();
  const scrolls = await loadRegistry();
  await renderScrollList(scrolls);
}

boot();
</script>
</body>
</html>
